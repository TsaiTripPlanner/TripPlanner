# 🌍 TripPlanner 旅遊規劃助手 - 功能與邏輯清單

這份文件記錄了本專案的核心功能與開發邏輯，作為未來維護與功能擴充的依據。

---

## 🏗️ 系統架構
- **前端框架**: React 19 (Hooks)
- **樣式工具**: Tailwind CSS
- **後端資料庫**: Firebase Firestore (即時同步)
- **身份驗證**: 行程通行碼機制 (Firebase Auth 匿名與 Email 模擬)
- **離線支援**: PWA (Service Worker) & Firestore 離線快取

---

## 📍 1. 行程規劃 (Itinerary)
- **多天數管理**: 支援動態天數切換。
- **排序邏輯 (重要)**: 
  1. 優先依照 `startTime` (時間) 排序。
  2. 若無時間或時間相同，則依照 `order` (手動拖拽順序) 排序。
  3. 技術實作: 搭配 Firestore 複合索引 (Composite Index) 確保查詢效能。
- **拖拽功能**: 整合 `@hello-pangea/dnd` 實現活動項目手動排序。
- **自動時長計算**: 輸入開始與結束時間後，自動計算並顯示持續小時/分鐘。
- **編輯功能**: 支援修改標題、地點、類型、時間、詳細說明與上傳景點圖片。

## 🎒 2. 清單管理 (Packing List)
- **分類系統**: 支援自定義類別 (例：電子產品、藥品)。
- **高效能數據處理**: 採用「雜湊映射 (Hash Map) 分組技術」，先將物品按類別 ID 分類後再進行渲染，大幅減少清單項目眾多時的處理負擔。
- **跨行程匯入**: 
  - 可從其他已存在的行程中匯入完整清單。
  - **排序保護**: 匯入時會自動在 `createdAt` 加入時間間隔，確保顯示順序與原始行程一致。
- **樂觀更新 (Optimistic UI)**: 點擊打勾時畫面立即反應，同步在背景寫入 Firebase。

## 💰 3. 旅行費用 (Budget)
- **多幣別支援**: TWD, JPY, KRW, USD 等常用幣別。
- **費用計算**:
  - **👤 單人模式**: 輸入單人金額，系統自動乘上旅伴人數計算總額。
  - **👥 總額模式**: 輸入整團花費，系統自動除以人數計算人均。
- **每日彙整**: 依天數分群顯示支出，並在頂部顯示該行程所有幣別的總結。
- **編輯模式一致化**：
  - 升級編輯模式佈局，為「天數、類別、項目名稱、細項備註、金額」加入微縮標籤 (text-[10px])。
  - 視覺邏輯與新增模式完全統一，降低使用者編輯時的認知成本。

## 📖 4. 參考資料庫 (Reference)
- **差異化分頁佈局**: 針對不同類型的資料提供最適合的視覺呈現。
- **圖片儲存**: 整合 Cloudinary API 實現圖片上傳。
- **交通指引 (Transport)**：專為路線圖與乘車截圖設計。採用垂直佈局，強化圖片顯示，並提供顯眼的外部連結按鈕。
- **景點介紹 (Spot Layout)**:
  - 雜誌感網格: 採用 Grid 佈局（電腦版雙欄 / 手機版單欄），視覺重心以圖片為主。
  - 電影感比例: 圖片統一強制 16:9 (aspect-video) 比例，確保版面整齊不參差。
  - 動態內容展開: 預設顯示三行精簡描述，支援「展開全文 / 收合」切換功能。
  - 排版優化: 支援 whitespace-pre-wrap 屬性，完整保留使用者輸入的換行與段落格式。
- **攻略收藏 (Guide)**:
  - 書籤清單樣式: 採用橫式佈局，小圖搭配標題與描述，適合快速瀏覽與點擊。
  - 外部鏈結整合: 提供一鍵開啟攻略網址功能，並優化了 Metadata 抓取流程。
  - 自動抓取: 輸入網址後，可透過 API 抓取網頁標題、預覽圖與描述 (Metadata)。
  - 整合原有的網頁書籤與攻略連結，相容舊版 link 類型資料。
- **介面細節優化**：
  - 新增「拖拽手把 (Menu Icon)」，僅在滑鼠懸停或觸控時顯示，保持版面簡潔。
  - 交通佈局圖片強制使用 object-contain 配合灰色背景，確保各類比例的地圖截圖都能清晰完整顯示。
- **📱 手機版介面優化**: 
  - 輸入框防溢出機制：在 flex 容器中的 input 必須強制加上 min-w-0。這是為了覆蓋瀏覽器對 input 標籤預設的 min-width（通常約 150px-200px），避免長內容或窄螢幕時將右側按鈕擠出可視區域。
  - 操作按鈕保護：關鍵按鈕（如「抓取」、「新增」）需設定 shrink-0，確保其在任何寬度下都不會被壓縮變形。
- **資料相容性與查詢優化**：
  - 前端排序策略：放棄 Firestore 端的 orderBy 查詢（避免隱藏缺少 order 欄位的舊資料），改由前端實施排序邏輯，確保所有歷史資料 100% 顯示。
  - 舊資料自動修復：舊資料（無 type 或 type="link"）會自動歸類至「攻略收藏」，且一旦進行拖拽排序，系統會自動補齊 order 數值。


---

## 🎨 5. 主題系統 (Theme)
- **莫蘭迪 (Morandi)**: 偏向冷色調、穩重的灰藍色系。
- **無印簡約 (Muji)**: 溫暖的木質調、米色與深啡色系。
- **切換機制**: 透過 `ThemeProvider` 全域管理顏色變數。

---

## 📈 6. 系統效能與維護
- **流量與空間節制**: 
  - 行程列表預設加入 limit(20)，僅抓取最近 20 筆行程，防止長期使用後資料過載。
  - **圖片預處理 (Image Compression)**：整合 `browser-image-compression`。上傳前自動在瀏覽器端將圖片壓縮至 1MB 以下，並限制最大解析度為 1280px。
  - **效益**：大幅縮短手機行動網路的上傳時間、節省 Cloudinary 儲存空間、並防止 Firestore 因為儲存過大 Base64 或 URL 導致讀取緩慢。
  - **EXIF 保護**：自動處理手機拍照的旋轉角度資訊，避免上傳後圖片倒置。

- **Firestore 查詢優化**: 全面導入 orderBy 進行預排序，減少行動裝置端的 CPU 運算。
- **索引維護**:
  - 必須針對 activities 集合建立複合索引：day (Asc) + startTime (Asc) + order (Asc)。
  - 必須針對 itineraries 集合建立單一欄位索引：startDate (Desc)。

---

## ⚠️ 開發注意事項 (防錯指引)
1. **Firebase 路徑**: 所有資料儲存在 `artifacts/my-trip-app-v18-burger-icon/users/{userId}/itineraries` 下。
2. **新增活動**: 在 `useActivities.js` 中新增活動時，必須確保賦予正確的 `day` 索引。
3. **時間格式**: 時間字串統一採用 24 小時制 (`HH:mm`)，以利於字串比較排序。
4. **圖片上傳**: 需確認 Cloudinary 的 `UPLOAD_PRESET` 是否正確設定。
5. **Firestore 排序特性陷阱**：在 useReferences.js 中，若使用資料庫端排序 (orderBy)，Firebase 會自動過濾掉不含該排序欄位的文檔。未來若有類似「為舊功能增加排序」的需求，應優先採用前端排序或全量補齊舊資料數值。
6. **分頁 ID 對應**：
  - transport: 交通
  - spot: 景點
  - guide: 攻略 (舊資料標籤 link 已映射至此)
---

## ✅ 測試 Checkbox (每次 Commit 前必測)
- [ ] 切換天數，活動列表是否正確更新？
- [ ] 補填活動時間後，卡片是否自動重新排序？
- [ ] 在「清單」分頁，匯入其他行程的資料是否排序正確？
- [ ] 費用計算的「單人/總額」切換是否正確連動？
- [ ] 離線狀態下修改資料，恢復連線後是否自動同步？
# 🌍 TripPlanner 旅遊規劃助手 - 功能與邏輯清單

這份文件記錄了本專案的核心功能與開發邏輯，作為未來維護與功能擴充的依據。

---

## 🏗️ 系統架構
- **前端框架**: React 19 (Hooks)
- **樣式工具**: Tailwind CSS
- **後端整合**:
  - Firebase Firestore: 實時數據同步與持久化離線緩存。
  - Firebase Auth: 採用「通行碼 (Access Code)」邏輯，簡化群組同步。
- **媒體處理**:
  - Cloudinary API: 雲端圖片存儲。
  - Browser Image Compression: 上傳前自動執行客戶端壓縮，節省流量。
- **離線支援**: PWA (Service Worker) 確保在無網路環境下仍可讀取快取內容。

---

## 📍 1. 行程規劃 (Itinerary)
- **多天數管理**: 支援動態天數切換。
- **進階排序系統**: 
  1. 優先依照 `startTime` (24小時制時間字串) 升序排列。
  2. 若無時間或時間相同，則依照手動拖拽產生的 `order` 序號排列。
  3. 技術實作: 搭配 Firestore 複合索引 (Composite Index) 確保查詢效能。
- **自動時長計算**: 輸入開始與結束時間後，自動計算並顯示持續小時/分鐘(e.g., 2h 30m)。
- **編輯功能**: 支援修改標題、地點、類型、時間、詳細說明與上傳景點圖片。
- **網址自動識別**：活動說明文字支援自動偵測連結並轉化為可點擊的超連結。
- **UI 強化**：
  - 地點直覺顯示：活動卡片在標題下方直接顯示「地點名稱」與圖釘圖示，無需展開即可確認目的地。
  - 防爆版面處理：針對長地點名稱實作 truncate 省略機制，確保在手機窄螢幕下卡片排版依舊整齊。
  - 自定義類型標籤: 針對景點、飲食、交通、住宿、購物、其他提供專屬配色與 Icon。
  - 拖拽體驗: 整合 @hello-pangea/dnd，支持流暢的手動排序。

## 🎒 2. 清單管理 (Packing List)
- **分類系統**: 支援自定義類別 (例：電子產品、藥品)。
- **雜湊映射分組 **:
  - 核心邏輯：在 usePackingList 中先將所有物品按類別 ID 映射分組，再進行一次性渲染。
  - 優點：大幅減少在大型清單（數百個項目）下的計算壓力。
- **跨行程智慧匯入**:
  - 支持從歷史行程複製完整清單。
  - 順序保護機制: 匯入時自動為新文檔注入時間間隔 (1000ms 間隔)，確保匯入後的顯示順序與來源行程完全一致。
- **樂觀更新 (Optimistic UI)**: 點擊打勾時畫面立即反應，背景異步寫入數據庫，提供零延遲的操作體感。

## 💰 3. 旅行費用 (Budget)
- **雙向金額計算**:
  - 👤 單人模式: 輸入每人預算，自動連動旅伴人數計算總金額。
  - 👥 整團模式: 分攤整筆支出，自動推算人均負擔。
- **多幣別概覽**: 頂部看板自動分類統計所有支出幣別 (TWD, JPY, USD...)，並同時顯示「整團總計」與「人均分攤」。
- **每日彙整**: 依天數分群顯示支出，並在頂部顯示該行程所有幣別的總結。
- **編輯模式一致化**：修改現有支出時，UI 佈局與新增模式完全對齊，並加入微縮標籤 (Label)，提升填寫精準度。
- **高效能即時結算**：利用 React useMemo 實作多幣別彙整邏輯，確保在資料量增加時，總額計算依然流暢無卡頓。

## 📖 4. 參考資料庫 (Reference)
這是一個複合型資料庫，針對不同類型的旅行資訊提供專屬的輸入介面與呈現方式。
# 核心呈現模式 (Layout Modes)
- **交通指引 (Transport)**：
  - 寬螢幕列表：適合存放乘車時刻表、轉乘地圖截圖。
  - 圖像優先：圖片強制使用 object-contain 配合灰色背景，確保各類比例的地圖截圖完整顯示。
  - 外部連結：顯眼的寬版按鈕，方便一鍵跳轉至 Google Maps 或鐵路官網。
- **景點介紹 (Spot Layout)**:
  - 雜誌感網格: 16:9 比例縮圖，具備視覺重心。
  - 摘要顯示：列表僅顯示「介紹」分頁的前兩行內容（Line-clamp）。
  - 完整詳情視窗 (Detail Modal): 點擊後開啟全螢幕 Modal，包含大圖、五大分頁導覽、以及富文本內容。
  - 排版優化: 支援 whitespace-pre-wrap 屬性，完整保留使用者輸入的換行與段落格式。
- **攻略收藏 (Guide)**:
  - 書籤樣式：專為部落格、Dcard、PTT 連結設計，側邊顯示小縮圖。
  - 相容性：自動收納舊版本中 type="link" 或未定義類型（Legacy data）的資料。

# 進階編輯與資料處理 (Internal Logic)
- **五大子分頁系統 (Sub-tabs)**：
  - 景點資料採「標籤式存儲」，分為：介紹、美食、特色店家、附近景點、注意事項。
  - 解析器 (Parser)：實作 parseSpotContent 邏輯，利用正則表達式偵測 [美食] 等標籤，將長字串拆解為物件分頁。
  - 組合器 (Assembler)：實作 assembleSpotContent 邏輯，將各分頁內容重新封裝為帶有標籤的字串存入資料庫，確保跨裝置相容。
- **智慧工具列 (Editor Toolbar)**：
  - 在內容編輯區提供快捷按鈕：標題 (#)、粗體 (**)、清單 (-)、分隔線 (---)。
  - 游標定位邏輯：點擊工具列後，程式會自動計算 selectionStart/End，將語法插入游標位置並重新聚焦 (Focus)。
- **Metadata 自動抓取**：
  - 整合 Microlink API，貼上網址後自動抓取網頁的 og:title、og:image 與描述。

# 互動與排序 (UX & Sorting)
- **前端排序策略 (Frontend Sorting)**：
  - 為了避免 Firestore 的 orderBy 過濾掉缺少 order 欄位的舊資料，系統採用「全量讀取後前端排序」。
  - 優先級：order (數值) > createdAt (時間)。
- **拖拽手把 (Drag Handle)**：
  - 整合 @hello-pangea/dnd。手把僅在 Hover 或觸控時出現，維持介面整潔。
- **智慧文本 (SmartText)**：
  - 全區支援 Markdown 渲染（標題變大、粗體加深）。
  - 網址自動偵測並轉化為可點擊連結。
- **📱 手機版介面優化**: 
  - 輸入框防溢出機制：在 flex 容器中的 input 必須強制加上 min-w-0。這是為了覆蓋瀏覽器對 input 標籤預設的 min-width（通常約 150px-200px），避免長內容或窄螢幕時將右側按鈕擠出可視區域。
  - 操作按鈕保護：關鍵按鈕（如「抓取」、「新增」）需設定 shrink-0，確保其在任何寬度下都不會被壓縮變形。
-

---

## 🎨 5. 全域優化與 UI/UX 細節
- **雙主題系統**:
  - 莫蘭迪 (Morandi): 穩重灰藍色調，適合追求質感的規劃者。
  - 無印簡約 (Muji): 溫暖木質調、米色系，搭配 Noto Serif TC 襯線字體，提升閱讀美感。
  - 切換機制: 透過 `ThemeProvider` 全域管理顏色變數。
- **行動端適配 (Responsive Fixes)**:
  - 防溢出機制: 針對所有輸入框實作 min-w-0 與 box-sizing 保護，確保在 iPhone SE 等窄螢幕上按鈕不被擠壓。
  - 安全區域 (Safe Area): 底部導覽列考量 iOS Home Indicator 避讓。
- **圖片上傳優化**:
  - 整合 Web Worker 進行背景壓縮，避免 UI 在處理大圖時卡頓。
  - 自動偵測並修正手機拍照的 EXIF 旋轉問題。
- **持久化登入**：自動記錄最後一次使用的通行碼於瀏覽器，實現「開啟即用」的同步體驗。
- **安全刪除機制**：關鍵數據（行程、大型清單、費用項目）刪除前均設有二次確認彈窗，防止誤觸導致資料遺失。

---

## 📈 6. 系統效能與維護
- **流量與空間節制**: 
  - 行程列表預設加入 limit(20)，僅抓取最近 20 筆行程，防止長期使用後資料過載。
- **圖片預處理 (Image Compression)**：整合 `browser-image-compression`。上傳前自動在瀏覽器端將圖片壓縮至 0.8MB 以下，並限制最大解析度為 1280px。
- **上傳進度回饋**：實作壓縮與上傳的進度顯示條，提升使用者對長時間處理過程的心理預期。

- **Firestore 查詢優化**: 全面導入 orderBy 進行預排序，減少行動裝置端的 CPU 運算。
- **索引維護**:
  - 必須針對 itineraries 集合建立單一欄位索引：startDate (Desc)。

---

## ⚠️ 開發維護須知
1. **索引要求**: activities 集合必須建立 day (Asc) + startTime (Asc) + order (Asc) 的複合索引。
2. **數據路徑**: 資料嚴格隔離於 artifacts/{appId}/users/{userId}/itineraries 路徑下。
3. **排序特性**: Reference 模組採用「前端排序」，確保未定義 order 欄位的舊數據不會因資料庫篩選而消失。
4. **環境變數**: 圖片功能依賴 Cloudinary Trip Photo preset；Metadata 抓取依賴 Microlink API。
5. **新增活動**: 在 `useActivities.js` 中新增活動時，必須確保賦予正確的 `day` 索引。
6. **時間格式**: 時間字串統一採用 24 小時制 (`HH:mm`)，以利於字串比較排序。
7. **圖片上傳**: 需確認 Cloudinary 的 `UPLOAD_PRESET` 是否正確設定。
8. **Firestore 排序特性陷阱**：在 useReferences.js 中，若使用資料庫端排序 (orderBy)，Firebase 會自動過濾掉不含該排序欄位的文檔。未來若有類似「為舊功能增加排序」的需求，應優先採用前端排序或全量補齊舊資料數值。
9. **分頁 ID 對應**：
  - transport: 交通
  - spot: 景點
  - guide: 攻略 (舊資料標籤 link 已映射至此)
---

## ✅ 測試 Checkbox (每次 Commit 前必測)
- [ ] 切換天數，活動列表是否正確更新？
- [ ] 補填活動時間後，卡片是否自動重新排序？
- [ ] 在「清單」分頁，匯入其他行程的資料是否排序正確？
- [ ] 費用計算的「單人/總額」切換是否正確連動？
- [ ] 離線狀態下修改資料，恢復連線後是否自動同步？
- [ ] PWA 安裝與快取更新機制 (Service Worker V1.0.1)。
- [ ] 大量圖片上傳時的內存管理 (自動壓縮至 0.8MB)。
- [ ] 跨行程匯入時的 Timestamp 排序衝突預防。
- [ ] 各種幣別的 toLocaleString() 金額格式化。
- [ ] 關閉分頁再開啟是否自動進入上次行程？
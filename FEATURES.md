# 🌍 TripPlanner 旅遊規劃助手 - 功能與邏輯清單

這份文件記錄了本專案的核心功能與開發邏輯，作為未來維護與功能擴充的依據。

---

## 🏗️ 系統架構
- **前端框架**: React 19 (Hooks)
- **樣式工具**: Tailwind CSS
- **後端資料庫**: Firebase Firestore (即時同步)
- **身份驗證**: 行程通行碼機制 (Firebase Auth 匿名與 Email 模擬)
- **離線支援**: PWA (Service Worker) & Firestore 離線快取

---

## 📍 1. 行程規劃 (Itinerary)
- **多天數管理**: 支援動態天數切換。
- **排序邏輯 (重要)**: 
  1. 優先依照 `startTime` (時間) 排序。
  2. 若無時間或時間相同，則依照 `order` (手動拖拽順序) 排序。
  3. 技術實作: 搭配 Firestore 複合索引 (Composite Index) 確保查詢效能。
- **拖拽功能**: 整合 `@hello-pangea/dnd` 實現活動項目手動排序。
- **自動時長計算**: 輸入開始與結束時間後，自動計算並顯示持續小時/分鐘。
- **編輯功能**: 支援修改標題、地點、類型、時間、詳細說明與上傳景點圖片。

## 🎒 2. 清單管理 (Packing List)
- **分類系統**: 支援自定義類別 (例：電子產品、藥品)。
- **高效能數據處理**: 採用「雜湊映射 (Hash Map) 分組技術」，先將物品按類別 ID 分類後再進行渲染，大幅減少清單項目眾多時的處理負擔。
- **跨行程匯入**: 
  - 可從其他已存在的行程中匯入完整清單。
  - **排序保護**: 匯入時會自動在 `createdAt` 加入時間間隔，確保顯示順序與原始行程一致。
- **樂觀更新 (Optimistic UI)**: 點擊打勾時畫面立即反應，同步在背景寫入 Firebase。

## 💰 3. 旅行費用 (Budget)
- **多幣別支援**: TWD, JPY, KRW, USD 等常用幣別。
- **費用計算**:
  - **👤 單人模式**: 輸入單人金額，系統自動乘上旅伴人數計算總額。
  - **👥 總額模式**: 輸入整團花費，系統自動除以人數計算人均。
- **每日彙整**: 依天數分群顯示支出，並在頂部顯示該行程所有幣別的總結。

## 📖 4. 參考資料庫 (Reference)
- **分類管理**: 分為「景點介紹」與「交通/攻略」。
- **差異化分頁佈局**: 針對不同類型的資料提供最適合的視覺呈現。
- **圖片儲存**: 整合 Cloudinary API 實現圖片上傳。
- **景點介紹 (Spot Layout)**:
  - 雜誌感網格: 採用 Grid 佈局（電腦版雙欄 / 手機版單欄），視覺重心以圖片為主。
  - 電影感比例: 圖片統一強制 16:9 (aspect-video) 比例，確保版面整齊不參差。
  - 動態內容展開: 預設顯示三行精簡描述，支援「展開全文 / 收合」切換功能。
  - 排版優化: 支援 whitespace-pre-wrap 屬性，完整保留使用者輸入的換行與段落格式。
- **交通/攻略 (Link Layout)**:
  - 書籤清單樣式: 採用橫式佈局，小圖搭配標題與描述，適合快速瀏覽與點擊。
  - 外部鏈結整合: 提供一鍵開啟攻略網址功能，並優化了 Metadata 抓取流程。
  - 自動抓取: 輸入網址後，可透過 API 抓取網頁標題、預覽圖與描述 (Metadata)。
- **📱 手機版介面優化**: 
  - 網址輸入框使用 `min-w-0` 與 `flex-1`，確保在小螢幕上長網址不會將「抓取」按鈕擠出螢幕。
  - 「抓取」按鈕設定 `shrink-0`，保證操作區域始終可見。


---

## 🎨 5. 主題系統 (Theme)
- **莫蘭迪 (Morandi)**: 偏向冷色調、穩重的灰藍色系。
- **無印簡約 (Muji)**: 溫暖的木質調、米色與深啡色系。
- **切換機制**: 透過 `ThemeProvider` 全域管理顏色變數。

---

## 📈 6. 系統效能與維護
- **流量節制**: 行程列表預設加入 limit(20)，僅抓取最近 20 筆行程，防止長期使用後資料過載。
- **Firestore 查詢優化**: 全面導入 orderBy 進行預排序，減少行動裝置端的 CPU 運算。
- **索引維護**:
  - 必須針對 activities 集合建立複合索引：day (Asc) + startTime (Asc) + order (Asc)。
  - 必須針對 itineraries 集合建立單一欄位索引：startDate (Desc)。

---

## ⚠️ 開發注意事項 (防錯指引)
1. **Firebase 路徑**: 所有資料儲存在 `artifacts/my-trip-app-v18-burger-icon/users/{userId}/itineraries` 下。
2. **新增活動**: 在 `useActivities.js` 中新增活動時，必須確保賦予正確的 `day` 索引。
3. **時間格式**: 時間字串統一採用 24 小時制 (`HH:mm`)，以利於字串比較排序。
4. **圖片上傳**: 需確認 Cloudinary 的 `UPLOAD_PRESET` 是否正確設定。

---

## ✅ 測試 Checkbox (每次 Commit 前必測)
- [ ] 切換天數，活動列表是否正確更新？
- [ ] 補填活動時間後，卡片是否自動重新排序？
- [ ] 在「清單」分頁，匯入其他行程的資料是否排序正確？
- [ ] 費用計算的「單人/總額」切換是否正確連動？
- [ ] 離線狀態下修改資料，恢復連線後是否自動同步？